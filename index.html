<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© ğŸŒ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/Ø¹Ø±ÙØ§Øª Ø§Ø­Ù…Ø¯ âš›ï¸ Ù…ØªÙƒØ§Ù…Ù„ - ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Firestore)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{--primary: #10b981; /* Ø²Ù…Ø±Ø¯ÙŠ */ --secondary: #3b82f6; /* Ø£Ø²Ø±Ù‚ */ --muted: #6b7280; --bg:#f3f4f6}
  body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); margin:0; padding:0; direction:rtl; text-align:right;}
  header{background:var(--primary); color:#fff; padding:16px 18px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  h1{font-size:1.75rem; margin:0;}
  h3{font-size:1.25rem; margin-top:0.75rem; margin-bottom:0.5rem; border-bottom:2px solid #e5eeef; padding-bottom:4px; color:#1f2937}
  .container{padding:20px; max-width:1400px; margin:auto}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; justify-content:center}
  .tabs button{background:#fff; border:1px solid #ddd; padding:10px 14px; border-radius:8px; cursor:pointer; transition:all 0.3s; font-weight:600}
  .tabs button.active{background:var(--secondary); color:#fff; border-color:var(--secondary); box-shadow:0 4px 6px rgba(59,130,246,0.3)}
  .tabs button:hover:not(.active){background:#f9fafb}
  .panel{display:none; background:#fff; padding:20px; border-radius:10px; border:1px solid #e5e7eb; box-shadow:0 10px 15px -3px rgba(0, 0, 0, 0.1)}
  .panel.active{display:block}
  table{width:100%; border-collapse:collapse; margin-top:12px; font-size:0.9rem;}
  th,td{border:1px solid #d1d5db; padding:10px; text-align:center; vertical-align:middle;}
  th{background:var(--secondary); color:#fff; font-weight:600; white-space:nowrap;}
  input,select,textarea{width:100%; box-sizing:border-box; padding:8px; border:1px solid #d1d5db; border-radius:4px; transition:border-color 0.2s}
  input:focus,select:focus,textarea:focus{border-color:var(--primary); outline:none;}
  .row{display:flex; gap:12px; margin-bottom:12px}
  .col{flex:1; min-width:0;}
  .actions{margin-top:15px; display:flex; gap:10px; justify-content:flex-start;}
  button.primary{background:var(--primary); color:#fff; border:none; padding:10px 16px; border-radius:6px; font-weight:600; transition:background 0.2s}
  button.primary:hover{background:#059669;}
  button.ghost{background:#f3f4f6; border:1px solid #d1d5db; color:#1f2937; padding:10px 16px; border-radius:6px; transition:background 0.2s}
  button.ghost:hover{background:#e5e7eb;}
  #popup{display:none; position:fixed; right:50%; transform:translateX(50%); top:10%; width:90%; max-width:600px; max-height:80%; background:#fff; border:3px solid var(--primary); z-index:999; padding:20px; border-radius:10px; box-shadow:0 10px 20px rgba(0,0,0,0.2); overflow:auto;}
  #popup table th{background:var(--primary)}
  footer{padding:15px; text-align:center; color:var(--muted); margin-top:20px;}
  .small-btn{padding:5px 8px; font-size:0.8rem;}
  .loading-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; font-size:1.5rem; font-weight:600; color:var(--primary); display:none;}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
</div>
<header>
  <h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ù…ØªÙƒØ§Ù…Ù„ - ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Firestore)</h1>
</header>
<div class="container">
  <div class="tabs" id="tabs">
    <button class="active" data-panel="itemsPanel">Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
    <button data-panel="suppliersPanel">Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†</button>
    <button data-panel="customersPanel">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    <button data-panel="purchasesPanel">ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    <button data-panel="salesPanel">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button data-panel="journalPanel">Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
  </div>

  <!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
  <section id="itemsPanel" class="panel active">
    <h3>ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
    <div class="actions">
      <button class="primary" onclick="addItemRow()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
      <button class="ghost" onclick="recomputeJournal()">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)</button>
    </div>
    <table id="itemsTable">
      <thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„ØµÙ†Ù</th><th>ÙƒÙˆØ¯</th><th>Ø§Ø³Ù…_Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø³Ø¹Ø±_Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø³Ø¹Ø±_Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ø­Ø¯_Ø§Ù„Ø£Ø¯Ù†Ù‰</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† -->
  <section id="suppliersPanel" class="panel">
    <h3>ğŸ­ Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†</h3>
    <div class="actions">
      <button class="primary" onclick="addSupplierRow()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
    </div>
    <table id="suppliersTable">
      <thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <section id="customersPanel" class="panel">
    <h3>ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
    <div class="actions">
      <button class="primary" onclick="addCustomerRow()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
    </div>
    <table id="customersTable">
      <thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ù…Ø´ØªØ±ÙŠØ§Øª -->
  <section id="purchasesPanel" class="panel">
    <h3>ğŸ“„ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
    <div class="row">
      <div class="col">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
        <select id="purchasePayment" onchange="togglePurchaseSupplier()">
          <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ (ØµÙ†Ø¯ÙˆÙ‚)</option>
          <option value="bank">Ø¨Ù†Ùƒ</option>
          <option value="credit">Ø¢Ø¬Ù„ (Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø©)</option>
        </select>
      </div>
      <div class="col" id="purchaseSupplierDiv" style="display:none">
        <label>Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø³Ù…/Ø±Ù‚Ù…):</label>
        <input id="purchaseSupplier" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" onclick="openPopupFor(this, 'suppliers')">
      </div>
      <div class="col">
        <label>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù†Ù‚Ù„:</label>
        <input id="purchaseTransport" type="number" value="0" oninput="recalcPurchaseGrand()">
      </div>
      <div class="col">
        <label>Ø®ØµÙ… Ù…ÙƒØªØ³Ø¨:</label>
        <input id="purchaseDiscount" type="number" value="0" oninput="recalcPurchaseGrand()">
      </div>
    </div>
    <table id="purchaseItemsTable">
      <thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„ØµÙ†Ù</th><th>Ø§Ø³Ù…_Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±_Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø®ØªÙŠØ§Ø±</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button class="primary" onclick="addPurchaseRow()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
      <button class="ghost" onclick="savePurchase()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©)</button>
    </div>
    <h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="purchaseGrand" class="text-xl font-bold text-red-600">0</span></h4>
  </section>

  <!-- Ù…Ø¨ÙŠØ¹Ø§Øª -->
  <section id="salesPanel" class="panel">
    <h3>ğŸ“„ ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
    <div class="row">
      <div class="col">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
        <select id="salesPayment" onchange="toggleSalesCustomer()">
          <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ (ØµÙ†Ø¯ÙˆÙ‚)</option>
          <option value="bank">Ø¨Ù†Ùƒ</option>
          <option value="credit">Ø¢Ø¬Ù„ (Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©)</option>
        </select>
      </div>
      <div class="col" id="salesCustomerDiv" style="display:none">
        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø³Ù…/Ø±Ù‚Ù…):</label>
        <input id="salesCustomer" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" onclick="openPopupFor(this, 'customers')">
      </div>
      <div class="col">
        <label>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ­Ù…ÙŠÙ„:</label>
        <input id="salesShipping" type="number" value="0" oninput="recalcSalesGrand()">
      </div>
      <div class="col">
        <label>Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­:</label>
        <input id="salesDiscount" type="number" value="0" oninput="recalcSalesGrand()">
      </div>
    </div>
    <table id="salesItemsTable">
      <thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„ØµÙ†Ù</th><th>Ø§Ø³Ù…_Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±_Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø®ØªÙŠØ§Ø±</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button class="primary" onclick="addSalesRow()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
      <button class="ghost" onclick="saveSale()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©)</button>
    </div>
    <h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="salesGrand" class="text-xl font-bold text-red-600">0</span></h4>
  </section>

  <!-- Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
  <section id="journalPanel" class="panel">
    <h3>ğŸ“˜ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ)</h3>
    <p class="text-sm text-gray-500 mb-4">Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¬Ù…Ø¹ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø­ÙØ¸ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.</p>
    <table id="journalTable"><thead><tr><th>Ø±Ù‚Ù…_Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody></tbody></table>
  </section>
</div>

<!-- Popup Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù/Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†/Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div id="popup">
  <h3 id="popupTitle">Ù‚Ø§Ø¦Ù…Ø©</h3>
  <div style="margin-bottom:8px"><input id="popupSearch" placeholder="Ø§Ø¨Ø­Ø«..." oninput="renderPopupList()"></div>
  <table id="popupTable"><thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù…Ø¹Ù„ÙˆÙ…Ø©</th><th>Ø§Ø®ØªÙŠØ§Ø±</th></tr></thead><tbody></tbody></table>
  <div style="margin-top:15px;text-align:left"><button class="ghost" onclick="closePopup()">Ø¥ØºÙ„Ø§Ù‚</button></div>
</div>

<footer>
  Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Firestore Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ. Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="userIdDisplay" class="font-mono text-xs text-blue-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, runTransaction, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  setLogLevel('Debug'); // ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Firestore

  // Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Ù…ÙÙ‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…)
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-acc-app';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  /* ---------------- Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© ÙˆØªÙ‡ÙŠØ¦Ø© ---------------- */
  let db, auth;
  let userId = null;
  let isAuthReady = false;

  // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ø¨Ø± onSnapshot
  let items = [];
  let suppliers = [];
  let customers = [];
  let purchases = [];
  let sales = [];
  let journal = [];

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  const loadingOverlay = document.getElementById('loadingOverlay');
  const userIdDisplay = document.getElementById('userIdDisplay');

  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  loadingOverlay.style.display = 'flex';

  // ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  async function initFirebaseAndAuth() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
        } else {
          // ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ­Ø¯Ø« Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø®ØµØµØ©/Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„Ø©
          userId = crypto.randomUUID();
          console.error("Authentication failed, falling back to random user ID.");
        }
        userIdDisplay.innerText = userId;
        isAuthReady = true;
        loadingOverlay.style.display = 'none';
        setupListeners();
      });

    } catch (error) {
      console.error("Firebase Initialization or Authentication Error:", error);
      userIdDisplay.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©';
      loadingOverlay.style.display = 'none';
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠ Firestore
  function getCollectionRef(collectionName) {
    if (!db || !userId) {
      console.error("Firestore DB or User ID is not ready.");
      return null;
    }
    // Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ©: /artifacts/{appId}/users/{userId}/{collectionName}
    return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (onSnapshot)
  function setupListeners() {
    if (!isAuthReady) return;

    // Ø§Ù„Ø£ØµÙ†Ø§Ù (Items)
    onSnapshot(getCollectionRef('items'), (snapshot) => {
      items = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      renderItems();
      console.log("Items updated:", items.length);
    }, (error) => console.error("Error fetching items:", error));

    // Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† (Suppliers)
    onSnapshot(getCollectionRef('suppliers'), (snapshot) => {
      suppliers = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      renderSuppliers();
      console.log("Suppliers updated:", suppliers.length);
    }, (error) => console.error("Error fetching suppliers:", error));

    // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Customers)
    onSnapshot(getCollectionRef('customers'), (snapshot) => {
      customers = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      renderCustomers();
      console.log("Customers updated:", customers.length);
    }, (error) => console.error("Error fetching customers:", error));

    // Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Journal)
    onSnapshot(getCollectionRef('journal'), (snapshot) => {
      journal = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      renderJournal();
      console.log("Journal updated:", journal.length);
    }, (error) => console.error("Error fetching journal:", error));

    // ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Purchases) - Ù„Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†
    onSnapshot(getCollectionRef('purchases'), (snapshot) => {
      purchases = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      console.log("Purchases updated:", purchases.length);
    }, (error) => console.error("Error fetching purchases:", error));

    // ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Sales) - Ù„Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†
    onSnapshot(getCollectionRef('sales'), (snapshot) => {
      sales = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
      console.log("Sales updated:", sales.length);
    }, (error) => console.error("Error fetching sales:", error));

    // ØªÙ‡ÙŠØ¦Ø© ØµÙÙˆÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    if (document.querySelector('#purchaseItemsTable tbody').children.length === 0) addPurchaseRow();
    if (document.querySelector('#salesItemsTable tbody').children.length === 0) addSalesRow();
    recalcPurchaseGrand();
    recalcSalesGrand();
  }

  /* ---------------- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---------------- */
  function generateId(prefix = 'X') { return prefix + Date.now().toString(36).slice(-6) + Math.random().toString(36).substring(2, 5); }
  window.generateId = generateId; // Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† HTML

  // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§ØªØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  document.querySelectorAll('.tabs button').forEach(btn => btn.addEventListener('click', () => {
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(btn.dataset.panel).classList.add('active');
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    recalcPurchaseGrand();
    recalcSalesGrand();
  }));

  /* ---------------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ---------------- */
  window.renderItems = function() {
    const tbody = document.querySelector('#itemsTable tbody'); tbody.innerHTML = '';
    items.forEach(it => {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
      const remainingQty = (Number(it.total_purchases) || 0) - (Number(it.total_sales) || 0);
      let statusClass = remainingQty <= (it.min_qty || 0) ? 'bg-red-100 text-red-700 font-bold' : 'bg-green-100 text-green-700';

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.item_id}</td>
        <td><input value="${it.item_code || ''}" onchange="updateItem('${it.item_id}','item_code',this.value)"></td>
        <td><input value="${it.item_name || ''}" onchange="updateItem('${it.item_id}','item_name',this.value)"></td>
        <td><input value="${it.category || ''}" onchange="updateItem('${it.item_id}','category',this.value)"></td>
        <td><input value="${it.unit || ''}" onchange="updateItem('${it.item_id}','unit',this.value)"></td>
        <td><input type='number' value='${it.purchase_price || 0}' onchange="updateItem('${it.item_id}','purchase_price',this.value)"></td>
        <td><input type='number' value='${it.sale_price || 0}' onchange="updateItem('${it.item_id}','sale_price',this.value)"></td>
        <td><input type='number' value='${it.min_qty || 0}' onchange="updateItem('${it.item_id}','min_qty',this.value)"></td>
        <td class="${statusClass} text-sm">${remainingQty} ${it.unit || 'ÙˆØ­Ø¯Ø©'}</td>`;
      tbody.appendChild(tr);
    });
  }

  window.addItemRow = async function() {
    if (!db) return console.error("Database not initialized.");
    const newItem = { item_id: generateId('I'), item_code: '', item_name: 'ØµÙ†Ù Ø¬Ø¯ÙŠØ¯', category: '', unit: '', purchase_price: 0, sale_price: 0, min_qty: 0, total_purchases: 0, total_sales: 0 };
    try {
      // Ù†Ø³ØªØ®Ø¯Ù… setDoc Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ ID Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ item_id Ù…Ø¹ doc.id (Ø£Ùˆ Ø£ÙŠ Ø­Ù‚Ù„ Ø¢Ø®Ø± Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„ÙŠÙ‡)
      await setDoc(doc(getCollectionRef('items'), newItem.item_id), newItem);
      console.log("New item added with ID:", newItem.item_id);
    } catch (e) {
      console.error("Error adding document: ", e);
    }
  }

  window.updateItem = async function(id, field, value) {
    if (!db) return;
    const itemRef = doc(getCollectionRef('items'), id);
    const updateData = {};
    if (['purchase_price', 'sale_price', 'min_qty', 'total_purchases', 'total_sales'].includes(field)) {
      updateData[field] = Number(value);
    } else {
      updateData[field] = value;
    }
    try {
      await updateDoc(itemRef, updateData);
      console.log(`Item ${id} updated: ${field}`);
    } catch (e) {
      console.error("Error updating document: ", e);
    }
  }

  /* ---------------- Ù…ÙˆØ±Ø¯ÙˆÙ† Ùˆ Ø¹Ù…Ù„Ø§Ø¡ ---------------- */
  window.renderSuppliers = function() {
    const tbody = document.querySelector('#suppliersTable tbody'); tbody.innerHTML = '';
    suppliers.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.supplier_id}</td>
        <td><input value='${s.name || ''}' onchange="updateSupplier('${s.supplier_id}','name',this.value)"></td>
        <td><input value='${s.phone || ''}' onchange="updateSupplier('${s.supplier_id}','phone',this.value)"></td>
        <td><input value='${s.address || ''}' onchange="updateSupplier('${s.supplier_id}','address',this.value)"></td>
        <td><input type='number' value='${s.balance || 0}' onchange="updateSupplier('${s.supplier_id}','balance',this.value)"></td>`;
      tbody.appendChild(tr);
    });
  }

  window.addSupplierRow = async function() {
    if (!db) return;
    const s = { supplier_id: generateId('S'), name: 'Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯', phone: '', address: '', balance: 0 };
    try {
      await setDoc(doc(getCollectionRef('suppliers'), s.supplier_id), s);
    } catch (e) {
      console.error("Error adding supplier: ", e);
    }
  }

  window.updateSupplier = async function(id, field, val) {
    if (!db) return;
    const sRef = doc(getCollectionRef('suppliers'), id);
    const updateData = {};
    updateData[field] = (field === 'balance') ? Number(val) : val;
    try {
      await updateDoc(sRef, updateData);
    } catch (e) {
      console.error("Error updating supplier: ", e);
    }
  }

  window.renderCustomers = function() {
    const tbody = document.querySelector('#customersTable tbody'); tbody.innerHTML = '';
    customers.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.customer_id}</td>
        <td><input value='${c.name || ''}' onchange="updateCustomer('${c.customer_id}','name',this.value)"></td>
        <td><input value='${c.phone || ''}' onchange="updateCustomer('${c.customer_id}','phone',this.value)"></td>
        <td><input value='${c.address || ''}' onchange="updateCustomer('${c.customer_id}','address',this.value)"></td>
        <td><input type='number' value='${c.balance || 0}' onchange="updateCustomer('${c.customer_id}','balance',this.value)"></td>`;
      tbody.appendChild(tr);
    });
  }

  window.addCustomerRow = async function() {
    if (!db) return;
    const c = { customer_id: generateId('C'), name: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', phone: '', address: '', balance: 0 };
    try {
      await setDoc(doc(getCollectionRef('customers'), c.customer_id), c);
    } catch (e) {
      console.error("Error adding customer: ", e);
    }
  }

  window.updateCustomer = async function(id, field, val) {
    if (!db) return;
    const cRef = doc(getCollectionRef('customers'), id);
    const updateData = {};
    updateData[field] = (field === 'balance') ? Number(val) : val;
    try {
      await updateDoc(cRef, updateData);
    } catch (e) {
      console.error("Error updating customer: ", e);
    }
  }

  /* ---------------- Ù…Ø´ØªØ±ÙŠØ§Øª: Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ­ÙØ¸ ---------------- */
  window.addPurchaseRow = function() {
    const tbody = document.querySelector('#purchaseItemsTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="w-20 text-center" oninput="purchaseFill(this)" placeholder="Ø±Ù‚Ù…"></td>
      <td><input oninput="purchaseFill(this)" placeholder="Ø§Ø³Ù…"></td>
      <td><input type='number' value='1' oninput="purchaseCalc(this)" onkeydown="purchaseNext(event)"></td>
      <td><input type='number' oninput="purchaseCalc(this)" value='0'></td>
      <td><input readonly value='0'></td>
      <td><button class='small-btn primary' onclick="openPopupFor(this,'items')">Ø§Ø®ØªÙŠØ§Ø±</button></td>`;
    tbody.appendChild(tr);
    recalcPurchaseGrand();
  }

  window.purchaseFill = function(el) {
    const tr = el.closest('tr');
    const inputVal = el.value.trim().toLowerCase();
    let found = items.find(x => x.item_id === inputVal || x.item_code === inputVal || x.item_name.toLowerCase().includes(inputVal));
    if (found) {
      tr.cells[0].querySelector('input').value = found.item_id;
      tr.cells[1].querySelector('input').value = found.item_name;
      tr.cells[3].querySelector('input').value = found.purchase_price || 0;
      purchaseCalc(el);
    }
  }

  window.purchaseCalc = function(el) {
    const tr = el.closest('tr');
    const qty = Number(tr.cells[2].querySelector('input').value) || 0;
    const price = Number(tr.cells[3].querySelector('input').value) || 0;
    tr.cells[4].querySelector('input').value = (qty * price).toFixed(2);
    recalcPurchaseGrand();
  }

  window.recalcPurchaseGrand = function() {
    let total = 0;
    document.querySelectorAll('#purchaseItemsTable tbody tr').forEach(r => total += Number(r.cells[4].querySelector('input').value) || 0);
    const transport = Number(document.getElementById('purchaseTransport').value) || 0;
    const discount = Number(document.getElementById('purchaseDiscount').value) || 0;
    const net = total + transport - discount;
    document.getElementById('purchaseGrand').innerText = net.toFixed(2);
  }

  window.purchaseNext = function(e) { if (e.key === 'Enter') { e.preventDefault(); addPurchaseRow(); } }
  window.togglePurchaseSupplier = function() { document.getElementById('purchaseSupplierDiv').style.display = (document.getElementById('purchasePayment').value === 'credit') ? 'block' : 'none'; }

  window.savePurchase = async function() {
    if (!db) return;
    const supplierVal = document.getElementById('purchaseSupplier').value.trim();
    const paymentMethod = document.getElementById('purchasePayment').value;
    if (paymentMethod === 'credit' && supplierVal === '') { return alert('Ù…Ø·Ù„ÙˆØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¢Ø¬Ù„'); }

    const itemsList = [];
    let invoiceTotal = 0;
    document.querySelectorAll('#purchaseItemsTable tbody tr').forEach(r => {
      const id = r.cells[0].querySelector('input').value;
      const name = r.cells[1].querySelector('input').value;
      const qty = Number(r.cells[2].querySelector('input').value) || 0;
      const price = Number(r.cells[3].querySelector('input').value) || 0;
      const total = Number(r.cells[4].querySelector('input').value) || 0;
      if (id && qty > 0) {
        itemsList.push({ item_id: id, item_name_snapshot: name, purchase_price_snapshot: price, quantity: qty, total });
        invoiceTotal += total;
      }
    });

    if (itemsList.length === 0) return alert('Ø£Ø¯Ø®Ù„ ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');

    const purchaseId = generateId('P');
    const transport = Number(document.getElementById('purchaseTransport').value) || 0;
    const discount = Number(document.getElementById('purchaseDiscount').value) || 0;
    const netAmount = Number(document.getElementById('purchaseGrand').innerText) || 0;

    const purchase = {
      purchase_id: purchaseId,
      supplier: supplierVal,
      payment_method: paymentMethod,
      transport: transport,
      discount: discount,
      net_amount: netAmount,
      items: itemsList,
      created_at: new Date().toISOString()
    };

    // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© (Transaction) Ù„Ø¶Ù…Ø§Ù† Ø§ØªØ³Ø§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
      await runTransaction(db, async (transaction) => {
        // 1. Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        const purchaseRef = doc(getCollectionRef('purchases'), purchaseId);
        transaction.set(purchaseRef, purchase);

        // 2. ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        itemsList.forEach(li => {
          const itemDoc = items.find(x => x.item_id === li.item_id);
          if (itemDoc) {
            const itemRef = doc(getCollectionRef('items'), itemDoc.item_id);
            const newTotalPurchases = (Number(itemDoc.total_purchases) || 0) + li.quantity;
            transaction.update(itemRef, { total_purchases: newTotalPurchases });
          }
        });

        // 3. ØªÙˆÙ„ÙŠØ¯ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ù‚ÙŠØ¯ Ù…Ø¨Ø³Ø·: Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†/Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†)
        const journalId = generateId('J');
        const journalEntry = {
          journal_id: journalId,
          date: new Date().toISOString(),
          reference: purchaseId,
          description: `ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª (ØµØ§ÙÙŠ: ${netAmount.toFixed(2)})`,
          debit: netAmount,
          credit: netAmount,
          details: {
            "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†/Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª": invoiceTotal.toFixed(2),
            "Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù†Ù‚Ù„": transport.toFixed(2),
            "Ø®ØµÙ… Ù…ÙƒØªØ³Ø¨": (-discount).toFixed(2),
            [paymentMethod === 'credit' ? 'Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø©/' + supplierVal : 'ØµÙ†Ø¯ÙˆÙ‚/Ø¨Ù†Ùƒ']: netAmount.toFixed(2)
          }
        };
        const journalRef = doc(getCollectionRef('journal'), journalId);
        transaction.set(journalRef, journalEntry);

        alert(`âœ… ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­. Ù…Ø¹Ø±Ù: ${purchaseId}`);
      });
    } catch (e) {
      console.error("Transaction failed: ", e);
      alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ù‚ÙŠØ¯. Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….');
    }
  }


  /* ---------------- Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ---------------- */
  window.addSalesRow = function() {
    const tbody = document.querySelector('#salesItemsTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="w-20 text-center" oninput="salesFill(this)" placeholder="Ø±Ù‚Ù…"></td>
      <td><input oninput="salesFill(this)" placeholder="Ø§Ø³Ù…"></td>
      <td><input type='number' value='1' oninput="salesCalc(this)" onkeydown="salesNext(event)"></td>
      <td><input type='number' oninput="salesCalc(this)" value='0'></td>
      <td><input readonly value='0'></td>
      <td><button class='small-btn primary' onclick="openPopupFor(this,'items')">Ø§Ø®ØªÙŠØ§Ø±</button></td>`;
    tbody.appendChild(tr);
    recalcSalesGrand();
  }

  window.salesFill = function(el) {
    const tr = el.closest('tr');
    const inputVal = el.value.trim().toLowerCase();
    let found = items.find(x => x.item_id === inputVal || x.item_code === inputVal || x.item_name.toLowerCase().includes(inputVal));
    if (found) {
      tr.cells[0].querySelector('input').value = found.item_id;
      tr.cells[1].querySelector('input').value = found.item_name;
      tr.cells[3].querySelector('input').value = found.sale_price || 0;
      salesCalc(el);
    }
  }

  window.salesCalc = function(el) {
    const tr = el.closest('tr');
    const qty = Number(tr.cells[2].querySelector('input').value) || 0;
    const price = Number(tr.cells[3].querySelector('input').value) || 0;
    tr.cells[4].querySelector('input').value = (qty * price).toFixed(2);
    recalcSalesGrand();
  }

  window.recalcSalesGrand = function() {
    let total = 0;
    document.querySelectorAll('#salesItemsTable tbody tr').forEach(r => total += Number(r.cells[4].querySelector('input').value) || 0);
    const ship = Number(document.getElementById('salesShipping').value) || 0;
    const disc = Number(document.getElementById('salesDiscount').value) || 0;
    const net = total + ship - disc;
    document.getElementById('salesGrand').innerText = net.toFixed(2);
  }

  window.salesNext = function(e) { if (e.key === 'Enter') { e.preventDefault(); addSalesRow(); } }
  window.toggleSalesCustomer = function() { document.getElementById('salesCustomerDiv').style.display = (document.getElementById('salesPayment').value === 'credit') ? 'block' : 'none'; }

  window.saveSale = async function() {
    if (!db) return;
    const customerVal = document.getElementById('salesCustomer').value.trim();
    const paymentMethod = document.getElementById('salesPayment').value;
    if (paymentMethod === 'credit' && customerVal === '') return alert('Ù…Ø·Ù„ÙˆØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¢Ø¬Ù„');

    const itemsList = [];
    let invoiceTotal = 0;
    document.querySelectorAll('#salesItemsTable tbody tr').forEach(r => {
      const id = r.cells[0].querySelector('input').value;
      const name = r.cells[1].querySelector('input').value;
      const qty = Number(r.cells[2].querySelector('input').value) || 0;
      const price = Number(r.cells[3].querySelector('input').value) || 0;
      const total = Number(r.cells[4].querySelector('input').value) || 0;
      if (id && qty > 0) {
        itemsList.push({ item_id: id, item_name_snapshot: name, sale_price_snapshot: price, quantity: qty, total });
        invoiceTotal += total;
      }
    });

    if (itemsList.length === 0) return alert('Ø£Ø¯Ø®Ù„ ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');

    const saleId = generateId('SA');
    const shipping = Number(document.getElementById('salesShipping').value) || 0;
    const discount = Number(document.getElementById('salesDiscount').value) || 0;
    const netAmount = Number(document.getElementById('salesGrand').innerText) || 0;

    const sale = {
      sale_id: saleId,
      customer: customerVal,
      payment_method: paymentMethod,
      shipping: shipping,
      discount: discount,
      net_amount: netAmount,
      items: itemsList,
      created_at: new Date().toISOString()
    };

    // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© (Transaction) Ù„Ø¶Ù…Ø§Ù† Ø§ØªØ³Ø§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
      await runTransaction(db, async (transaction) => {
        // 1. Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        const saleRef = doc(getCollectionRef('sales'), saleId);
        transaction.set(saleRef, sale);

        // 2. ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        itemsList.forEach(li => {
          const itemDoc = items.find(x => x.item_id === li.item_id);
          if (itemDoc) {
            const itemRef = doc(getCollectionRef('items'), itemDoc.item_id);
            const newTotalSales = (Number(itemDoc.total_sales) || 0) + li.quantity;
            transaction.update(itemRef, { total_sales: newTotalSales });
          }
        });

        // 3. ØªÙˆÙ„ÙŠØ¯ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ù‚ÙŠØ¯ Ù…Ø¨Ø³Ø·: Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)
        const journalId = generateId('J');
        const journalEntry = {
          journal_id: journalId,
          date: new Date().toISOString(),
          reference: saleId,
          description: `ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª (ØµØ§ÙÙŠ: ${netAmount.toFixed(2)})`,
          debit: netAmount,
          credit: netAmount,
          details: {
            [paymentMethod === 'credit' ? 'Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©/' + customerVal : 'ØµÙ†Ø¯ÙˆÙ‚/Ø¨Ù†Ùƒ']: netAmount.toFixed(2),
            "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª": invoiceTotal.toFixed(2),
            "Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ­Ù…ÙŠÙ„": (-shipping).toFixed(2), // Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ù„Ù„ Ø§Ù„Ø¯Ø®Ù„
            "Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­": (-discount).toFixed(2)      // Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙŠÙ‚Ù„Ù„ Ø§Ù„Ø¯Ø®Ù„
          }
        };
        const journalRef = doc(getCollectionRef('journal'), journalId);
        transaction.set(journalRef, journalEntry);

        alert(`âœ… ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­. Ù…Ø¹Ø±Ù: ${saleId}`);
      });
    } catch (e) {
      console.error("Transaction failed: ", e);
      alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ù‚ÙŠØ¯. Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….');
    }
  }


  /* ---------------- Ù†Ø§ÙØ°Ø© Popup ---------------- */
  let popupContext = null; // 'items'|'suppliers'|'customers'
  let popupTargetRow = null;
  let popupTargetInput = null; // Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ© Ù…Ø«Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯/Ø§Ù„Ø¹Ù…ÙŠÙ„

  window.openPopupFor = function(el, ctx) {
    popupContext = ctx;
    if (ctx === 'items') {
      popupTargetRow = el.closest('tr');
      popupTargetInput = null;
    } else { // suppliers or customers
      popupTargetRow = null;
      popupTargetInput = el;
    }

    document.getElementById('popupTitle').innerText = (ctx === 'items') ? 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù' : (ctx === 'suppliers') ? 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' : 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
    document.getElementById('popupSearch').value = '';
    renderPopupList();
    document.getElementById('popup').style.display = 'block';
  }

  window.closePopup = function() {
    document.getElementById('popup').style.display = 'none';
    popupContext = null;
    popupTargetRow = null;
    popupTargetInput = null;
  }

  window.renderPopupList = function() {
    const q = document.getElementById('popupSearch').value.trim().toLowerCase();
    const tbody = document.querySelector('#popupTable tbody');
    tbody.innerHTML = '';
    let list = [];

    if (popupContext === 'items') list = items;
    if (popupContext === 'suppliers') list = suppliers;
    if (popupContext === 'customers') list = customers;

    list.filter(x => !q || (x.item_name && x.item_name.toLowerCase().includes(q)) || (x.name && x.name.toLowerCase().includes(q))).forEach(it => {
      const tr = document.createElement('tr');
      const id = popupContext === 'items' ? it.item_id : (it.supplier_id || it.customer_id);
      const name = popupContext === 'items' ? it.item_name : (it.name || '');
      const info = popupContext === 'items' ? `Ø´Ø±Ø§Ø¡: ${it.purchase_price || 0}` : (it.phone || 'N/A');

      tr.innerHTML = `<td>${id}</td><td>${name}</td><td>${info}</td>
        <td><button class='small-btn primary' onclick="popupSelect('${popupContext}','${id}')">Ø§Ø®ØªÙŠØ§Ø±</button></td>`;
      tbody.appendChild(tr);
    });
  }

  window.popupSelect = function(ctx, id) {
    if (ctx === 'items' && popupTargetRow) {
      const it = items.find(x => x.item_id === id);
      if (it) {
        // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù ÙÙŠ Ø³Ø·Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        popupTargetRow.cells[0].querySelector('input').value = it.item_id;
        popupTargetRow.cells[1].querySelector('input').value = it.item_name;

        // ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        const activePanel = document.querySelector('.panel.active').id;
        const priceIndex = (activePanel === 'purchasesPanel' ? 3 : 3); // ÙƒÙ„Ø§Ù‡Ù…Ø§ Ø§Ù„Ø®Ù„ÙŠØ© Ø±Ù‚Ù… 3
        const price = (activePanel === 'purchasesPanel' ? it.purchase_price : it.sale_price) || 0;

        popupTargetRow.cells[priceIndex].querySelector('input').value = price;
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        if (activePanel === 'purchasesPanel') purchaseCalc(popupTargetRow.cells[priceIndex].querySelector('input'));
        if (activePanel === 'salesPanel') salesCalc(popupTargetRow.cells[priceIndex].querySelector('input'));
      }
    }
    if (ctx === 'suppliers' && popupTargetInput) {
      const s = suppliers.find(x => x.supplier_id === id);
      if (s) popupTargetInput.value = s.name;
    }
    if (ctx === 'customers' && popupTargetInput) {
      const c = customers.find(x => x.customer_id === id);
      if (c) popupTargetInput.value = c.name;
    }
    closePopup();
  }


  /* ---------------- Ù‚ÙŠÙˆØ¯: Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù…Ø¨Ø³Ø· ---------------- */
  window.recomputeJournal = async function() {
    if (!db) return;
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØªÙˆÙ„ÙŠØ¯Ù‡Ø§ Ù…Ù† ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.')) return;

    try {
      const batch = writeBatch(db);
      const journalRef = getCollectionRef('journal');

      // 1. Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const oldDocs = await getDocs(journalRef);
      oldDocs.forEach(doc => batch.delete(doc.ref));

      // 2. ØªÙˆÙ„ÙŠØ¯ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
      purchases.forEach(p => {
        const journalId = generateId('J');
        const journalEntry = {
          journal_id: journalId,
          date: p.created_at,
          reference: p.purchase_id,
          description: `Ù‚ÙŠØ¯ Ù…Ø´ØªØ±ÙŠØ§Øª (ØµØ§ÙÙŠ: ${p.net_amount.toFixed(2)})`,
          debit: p.net_amount,
          credit: p.net_amount,
          details: { "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†/Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª": p.net_amount.toFixed(2), [p.payment_method === 'credit' ? 'Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø©' : 'ØµÙ†Ø¯ÙˆÙ‚/Ø¨Ù†Ùƒ']: p.net_amount.toFixed(2) }
        };
        batch.set(doc(journalRef, journalId), journalEntry);
      });

      // 3. ØªÙˆÙ„ÙŠØ¯ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
      sales.forEach(s => {
        const journalId = generateId('J');
        const journalEntry = {
          journal_id: journalId,
          date: s.created_at,
          reference: s.sale_id,
          description: `Ù‚ÙŠØ¯ Ù…Ø¨ÙŠØ¹Ø§Øª (ØµØ§ÙÙŠ: ${s.net_amount.toFixed(2)})`,
          debit: s.net_amount,
          credit: s.net_amount,
          details: { "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª": s.net_amount.toFixed(2), [s.payment_method === 'credit' ? 'Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©' : 'ØµÙ†Ø¯ÙˆÙ‚/Ø¨Ù†Ùƒ']: s.net_amount.toFixed(2) }
        };
        batch.set(doc(journalRef, journalId), journalEntry);
      });

      await batch.commit();
      alert('âœ… Ø£ÙØ¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…Ù† Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.');
    } catch (e) {
      console.error("Error during recompute journal transaction:", e);
      alert('âŒ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙˆØ¯. Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….');
    }
  }

  window.renderJournal = function() {
    const tbody = document.querySelector('#journalTable tbody'); tbody.innerHTML = '';
    // ÙØ±Ø² Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const sortedJournal = journal.sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedJournal.forEach(j => {
      const tr = document.createElement('tr');
      // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¨Ø§Ù„Ù‚ÙŠÙˆØ¯
      let detailsHtml = j.description;
      if (j.details) {
        detailsHtml += '<ul class="list-disc list-inside text-xs mt-1 text-gray-600">';
        for (const [account, amount] of Object.entries(j.details)) {
          detailsHtml += `<li>${account}: ${amount}</li>`;
        }
        detailsHtml += '</ul>';
      }

      tr.innerHTML = `<td>${j.journal_id}</td>
        <td>${new Date(j.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
        <td class="text-right">${detailsHtml}</td>
        <td class="font-bold text-green-700">${(j.debit || 0).toFixed(2)}</td>
        <td class="font-bold text-red-700">${(j.credit || 0).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }

  /* ---------------- Ø§Ù„ØªØ´ØºÙŠÙ„ ---------------- */
  initFirebaseAndAuth();

</script>
</body>
</html>
